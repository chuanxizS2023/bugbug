import pickle
import tarfile
import sys
import os
scripts_dir = os.path.dirname(os.path.abspath(__file__))
parent_dir = os.path.dirname(scripts_dir)
sys.path.append(parent_dir)

from bugbug.models.defect import DefectModel

# model = DefectModel()
# model.load(model_directory="../defectmodel")
# print("model name:", model)

model_directory = "../defectmodel"
model_path = os.path.join(model_directory, "model.pkl")
print("loading model from", model_path)
with open(model_path, "rb") as f:
    model = pickle.load(f)
    model.clf.named_steps["estimator"].load_model("../defectmodel/xgboost.ubj")

# Step 2: Prepare the Record
# Assuming 'record' is your data record in the required format
record = {"history":[{"when":"1998-09-29T06:05:20Z","who":"mcafee@gmail.com","changes":[{"added":"XFE","field_name":"component","removed":"Platform: Rhapsody"}]},{"who":"mcafee@gmail.com","changes":[{"field_name":"status","added":"RESOLVED","removed":"NEW"},{"removed":"","added":"WONTFIX","field_name":"resolution"},{"field_name":"cf_last_resolved","added":"1998-12-12T17:06:46Z","removed":""}],"when":"1998-12-12T17:06:46Z"},{"when":"1999-02-26T20:55:50Z","changes":[{"removed":"RESOLVED","field_name":"status","added":"VERIFIED"}],"who":"leger@formerly-netscape.com.tld"},{"changes":[{"added":"wlevine@gmail.com","field_name":"cc","removed":""}],"who":"wlevine@gmail.com","when":"2004-06-30T02:37:03Z"},{"changes":[{"field_name":"alias","added":"firstBug","removed":""}],"who":"gavin.sharp@gmail.com","when":"2004-09-22T05:11:42Z"},{"when":"2010-12-08T18:48:57Z","who":"tymerkaev@gmail.com","changes":[{"removed":"","field_name":"cc","added":"tymerkaev@gmail.com"}]},{"who":"gerv@mozilla.org","changes":[{"removed":"","field_name":"blocks","added":"686525"}],"when":"2011-09-13T20:41:18Z"},{"when":"2011-09-13T20:41:41Z","changes":[{"removed":"686525","field_name":"blocks","added":""}],"who":"gerv@mozilla.org"},{"when":"2013-05-03T17:18:17Z","changes":[{"removed":"","added":"rexyrexy2@gmail.com","field_name":"cc"}],"who":"rexyrexy2@gmail.com"},{"when":"2013-07-17T18:25:43Z","who":"dkl@mozilla.com","changes":[{"field_name":"whiteboard","added":"foo","removed":""}]},{"when":"2013-07-17T19:01:18Z","who":"dkl@mozilla.com","changes":[{"removed":"foo","field_name":"whiteboard","added":""}]},{"who":"hchang.mozilla@gmail.com","changes":[{"removed":"","field_name":"cc","added":"hchang@mozilla.com"}],"when":"2013-11-20T02:16:47Z"},{"changes":[{"removed":"","comment_id":1388133,"added":"off-topic","comment_count":4,"field_name":"comment_tag"}],"who":"glob@mozilla.com","when":"2014-06-17T07:40:56Z"},{"who":"glob@mozilla.com","changes":[{"field_name":"comment_tag","comment_count":5,"added":"off","comment_id":2264071,"removed":""}],"when":"2014-06-17T07:41:00Z"},{"when":"2014-06-17T07:41:02Z","who":"glob@mozilla.com","changes":[{"removed":"off","comment_id":2264071,"field_name":"comment_tag","added":"","comment_count":5}]},{"when":"2014-06-17T07:41:06Z","changes":[{"removed":"","field_name":"comment_tag","comment_count":5,"added":"off-topic","comment_id":2264071}],"who":"glob@mozilla.com"},{"who":"glob@mozilla.com","changes":[{"comment_id":7385215,"comment_count":6,"added":"off-topic","field_name":"comment_tag","removed":""}],"when":"2014-06-17T07:41:13Z"},{"when":"2014-06-17T07:41:18Z","who":"glob@mozilla.com","changes":[{"comment_id":8100476,"comment_count":7,"added":"off-topic","field_name":"comment_tag","removed":""}]},{"changes":[{"field_name":"flagtypes.name","added":"review?(jlaster@mozilla.com)","removed":"","attachment_id":8916321},{"removed":"","added":"jlaster@mozilla.com","field_name":"cc"}],"who":"jlaster@mozilla.com","when":"2017-10-07T23:07:35Z"},{"when":"2017-10-07T23:08:49Z","changes":[{"attachment_id":8916322,"removed":"","added":"review?(jlaster@mozilla.com)","field_name":"flagtypes.name"}],"who":"jlaster@mozilla.com"},{"who":"jlaster@mozilla.com","changes":[{"attachment_id":8916323,"removed":"","added":"review?(jlaster@mozilla.com)","field_name":"flagtypes.name"}],"when":"2017-10-07T23:09:58Z"},{"when":"2017-10-07T23:11:17Z","who":"jlaster@mozilla.com","changes":[{"removed":"","attachment_id":8916324,"added":"review?(jlaster@mozilla.com)","field_name":"flagtypes.name"}]},{"when":"2017-10-07T23:11:52Z","who":"jlaster@mozilla.com","changes":[{"field_name":"flagtypes.name","added":"review?(jlaster@mozilla.com)","removed":"","attachment_id":8916325}]},{"when":"2018-03-01T13:55:52Z","who":"jlaster@mozilla.com","changes":[{"added":"","field_name":"flagtypes.name","attachment_id":8916321,"removed":"review?(jlaster@mozilla.com)"}]},{"changes":[{"added":"","field_name":"flagtypes.name","attachment_id":8916322,"removed":"review?(jlaster@mozilla.com)"}],"who":"jlaster@mozilla.com","when":"2018-03-01T13:55:56Z"},{"when":"2018-03-01T13:56:00Z","changes":[{"attachment_id":8916323,"removed":"review?(jlaster@mozilla.com)","added":"","field_name":"flagtypes.name"}],"who":"jlaster@mozilla.com"},{"when":"2018-03-01T13:56:04Z","who":"jlaster@mozilla.com","changes":[{"removed":"review?(jlaster@mozilla.com)","attachment_id":8916324,"added":"","field_name":"flagtypes.name"}]},{"changes":[{"removed":"review?(jlaster@mozilla.com)","attachment_id":8916325,"field_name":"flagtypes.name","added":""}],"who":"jlaster@mozilla.com","when":"2018-03-01T13:56:10Z"},{"changes":[{"field_name":"comment_tag","added":"deleted","comment_count":17,"comment_id":13472971,"removed":""}],"who":"glob@mozilla.com","when":"2018-07-16T03:22:48Z"},{"changes":[{"removed":"","comment_id":13472970,"comment_count":16,"added":"deleted","field_name":"comment_tag"}],"who":"glob@mozilla.com","when":"2018-07-16T03:22:51Z"},{"when":"2018-07-16T03:22:54Z","changes":[{"field_name":"comment_tag","comment_count":15,"added":"deleted","comment_id":13472969,"removed":""}],"who":"glob@mozilla.com"},{"when":"2018-07-16T03:22:57Z","changes":[{"comment_id":13472968,"field_name":"comment_tag","comment_count":14,"added":"deleted","removed":""}],"who":"glob@mozilla.com"},{"when":"2018-07-16T03:23:00Z","changes":[{"removed":"","comment_count":13,"added":"deleted","field_name":"comment_tag","comment_id":13472966}],"who":"glob@mozilla.com"}],"comments":[{"count":0,"id":1,"creation_time":"1998-04-07T08:37:03Z","text":"Created by   (weitsang@cs.cornell.edu) on Monday, April 6, 1998 6:37:03 PM PDT\nAdditional Details :\nPREF_Cleanup is not called when Navigator exits\n(File->Exit), causing memory leaks.\nUpdated by Sarah Wilson (swilson@netscape.com) on Tuesday, April 7, 1998 6:48:16 PM PDT\nUpdated by Sarah Wilson (swilson@netscape.com) on Tuesday, April 7, 1998 6:49:27 PM PDT"},{"creation_time":"1998-09-29T06:05:59Z","text":"leaks on exit are low priority; yes we should fix this.","id":2,"count":1},{"id":3,"count":2,"creation_time":"1998-12-12T17:06:59Z","text":"N/A in new world."},{"text":"Marking Verified/Won't Fix","creation_time":"1999-02-26T20:55:59Z","count":3,"id":4},{"id":1388133,"count":4,"text":"Not at all related to this bug.\n\nWhich is the first ever bug to be submited at bugzilla ?.\nWhere is bug no 1 ?.\nIs there a bug earlier than this one ?.\nJust for Trivia sake","creation_time":"2002-06-08T20:22:21Z"},{"count":5,"id":2264071,"creation_time":"2004-09-18T09:02:47Z","text":"(In reply to comment #4)\n> Not at all related to this bug.\n> \n> Which is the first ever bug to be submited at bugzilla ?.\n> Where is bug no 1 ?.\n> Is there a bug earlier than this one ?.\n> Just for Trivia sake\n\nI think that this is the first ever bug here.\nrespect!\n\nDan-Shk"},{"text":"this is the first bug! I checked all ones before it. they say not valid.\n\nOne question: is it covered covered under the \"Archeological Artifacts Protection Act\" from 1998 like id 101 is?","creation_time":"2013-05-03T17:18:17Z","id":7385215,"count":6},{"creation_time":"2013-11-20T02:16:47Z","text":"Looks like I am not the only one curious about the very first bug :p","count":7,"id":8100476},{"id":12737812,"count":8,"text":"Created attachment 8916321\nTest Attachment\n\nThis is a new attachment comment","creation_time":"2017-10-07T23:07:35Z"},{"id":12737813,"count":9,"text":"Created attachment 8916322\nTest Attachment\n\nThis is a new attachment comment","creation_time":"2017-10-07T23:08:49Z"},{"count":10,"id":12737814,"text":"Created attachment 8916323\nTest Attachment\n\nThis is a new attachment comment","creation_time":"2017-10-07T23:09:58Z"},{"creation_time":"2017-10-07T23:11:17Z","text":"Created attachment 8916324\nTest Attachment\n\nThis is a new attachment comment","count":11,"id":12737815},{"text":"Created attachment 8916325\nTest Attachment\n\nThis is a new attachment comment","creation_time":"2017-10-07T23:11:52Z","count":12,"id":12737816}],"blocks":[],"creation_time":"1998-04-07T08:37:03Z","comment_count":18,"groups":[],"component":"XFE","last_change_time":"2018-07-16T03:22:35Z","is_confirmed":True,"whiteboard":"","mentors_detail":[],"cf_qa_whiteboard":"","cf_fx_points":"---","priority":"P3","cf_cab_review":"---","classification":"Graveyard","mentors":[],"id":35,"depends_on":[],"version":"1998-03-31","cc":["hchang.mozilla@gmail.com","jlaster@mozilla.com","rexyrexy2@gmail.com","tymerkaev@gmail.com","wlevine@gmail.com"],"flags":[],"assigned_to_detail":{"id":1672,"real_name":"Chris McAfee","name":"mcafee@gmail.com","nick":"mcafee","email":"mcafee@gmail.com"},"platform":"Sun","assigned_to":"mcafee@gmail.com","qa_contact":"","summary":"Navigator does not free preference hash table when exit.","url":"","cf_last_resolved":"1998-12-12T17:06:46Z","alias":"firstBug","status":"VERIFIED","duplicates":[],"severity":"minor","op_sys":"Solaris","regressions":[],"cf_fx_iteration":"---","dupe_of":None,"creator_detail":{"id":55,"real_name":"","email":"weitsang@cs.cornell.edu","name":"weitsang@cs.cornell.edu","nick":"weitsang"},"product":"MozillaClassic Graveyard","creator":"weitsang@cs.cornell.edu","resolution":"WONTFIX","see_also":[],"regressed_by":[],"is_cc_accessible":True,"is_creator_accessible":True,"cc_detail":[{"name":"hchang.mozilla@gmail.com","nick":"hchang","email":"hchang.mozilla@gmail.com","id":475800,"real_name":"Henry Chang [:hchang]"},{"real_name":"Jason Laster [:jlast]","id":555817,"nick":"jlast","name":"jlaster@mozilla.com","email":"jlaster@mozilla.com"},{"email":"rexyrexy2@gmail.com","nick":"rexyrexy2","name":"rexyrexy2@gmail.com","real_name":"","id":463956},{"id":356256,"real_name":"","nick":"tymerkaev","name":"tymerkaev@gmail.com","email":"tymerkaev@gmail.com"},{"real_name":"Will Levine","id":68465,"email":"wlevine@gmail.com","name":"wlevine@gmail.com","nick":"wlevine"}],"votes":0,"filed_via":"unknown","type":"defect","is_open":False,"keywords":[],"cf_user_story":"","target_milestone":"---","attachments":[{"is_patch":0,"content_type":"text/plain","creation_time":"2017-10-07T23:07:35Z","id":8916321,"file_name":"test_attachment.patch","flags":[]},{"id":8916322,"flags":[],"file_name":"test_attachment.patch","content_type":"text/plain","is_patch":0,"creation_time":"2017-10-07T23:08:49Z"},{"file_name":"test_attachment.patch","creation_time":"2017-10-07T23:09:58Z","flags":[],"id":8916323,"is_patch":0,"content_type":"text/plain"},{"creation_time":"2017-10-07T23:11:17Z","is_patch":0,"content_type":"text/plain","file_name":"test_attachment.patch","flags":[],"id":8916324},{"id":8916325,"file_name":"test_attachment.patch","flags":[],"is_patch":0,"content_type":"text/plain","creation_time":"2017-10-07T23:11:52Z"}]}


# Step 3: Predict
# You might need to wrap your record in a list
prediction = model.classify([record])
print("Prediction:", prediction)
